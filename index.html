<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAP & EARN</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --accent: #00d4ff;
            --accent-secondary: #7b61ff;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 15px;
            margin: 0 auto;
            padding-bottom: 80px; /* Space for bottom nav */
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        .card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }

        .btn {
            background-color: var(--accent);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--border-radius);
            padding: 12px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            text-align: center;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-secondary {
            background-color: var(--accent-secondary);
        }

        .btn:disabled {
            background-color: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--bg-secondary);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            border-top: 1px solid #333;
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s;
            text-align: center;
            flex: 1;
            max-width: 25%;
        }

        .nav-item.active {
            background-color: rgba(0, 212, 255, 0.1);
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 12px;
        }

        /* Header & Stats */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .stats {
            display: flex;
            gap: 15px;
        }

        .stat-item {
            background-color: var(--bg-secondary);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            text-align: center;
            min-width: 80px;
        }

        .stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Tap Section */
        .tap-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            position: relative;
        }

        .coin {
            width: 150px;
            height: 150px;
            background: linear-gradient(135deg, #26a17b 0%, #1e7e5c 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(38, 161, 123, 0.4);
            position: relative;
            user-select: none;
            transition: transform 0.1s;
        }

        .coin:active {
            transform: scale(0.95);
        }

        .tap-feedback {
            position: absolute;
            color: var(--accent);
            font-weight: bold;
            font-size: 24px;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
        }

        .tap-info {
            margin-top: 20px;
            text-align: center;
            color: var(--text-secondary);
        }

        /* Tasks Section */
        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .task-card {
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-info {
            flex: 1;
        }

        .task-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .task-description {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-reward {
            color: var(--accent);
            font-weight: 600;
            margin-left: 10px;
        }

        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-right: 15px;
            background-color: var(--bg-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .profile-info {
            flex: 1;
        }

        .profile-info h2 {
            margin-bottom: 5px;
        }

        .profile-id {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .referral-section {
            margin-top: 20px;
        }

        .referral-link {
            display: flex;
            margin-top: 10px;
        }

        .referral-link input {
            flex: 1;
            padding: 10px;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            border: 1px solid #333;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .copy-btn {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            padding: 10px 15px;
        }

        /* Withdrawal Section */
        .exchange-rate {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--bg-secondary);
            border-radius: var(--border-radius);
        }

        .withdrawal-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            border-radius: var(--border-radius);
            border: 1px solid #333;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }

        .withdrawal-history {
            margin-top: 30px;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .history-table th,
        .history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .history-table th {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .status-pending {
            color: #ffa500;
        }

        .status-approved {
            color: #26a17b;
        }

        .status-rejected {
            color: #ff4d4d;
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            padding: 20px;
            padding-bottom: 30px;
        }

        .admin-section {
            margin-bottom: 30px;
        }

        .admin-section h2 {
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .admin-table th,
        .admin-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #333;
        }

        .admin-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-form .full-width {
            grid-column: 1 / -1;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        @keyframes bounce {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        /* Utility Classes */
        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 600px;
            }
        }

        /* Password Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
        }

        .modal h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #333;
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <!-- Password Modal for Admin -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h2>Admin Access</h2>
            <input type="password" id="admin-password" class="modal-input" placeholder="Enter admin password">
            <button class="btn full-width" id="submit-password">Enter</button>
        </div>
    </div>

    <!-- Main App Interface -->
    <div id="app">
        <!-- Tap Section -->
        <section id="tap-section" class="section active">
            <div class="container">
                <div class="header">
                    <h1>💰 TAP & EARN</h1>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="coins-display">0</div>
                            <div class="stat-label">Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="level-display">1</div>
                            <div class="stat-label">Level</div>
                        </div>
                    </div>
                </div>
                
                <div class="tap-area">
                    <div class="coin" id="tap-coin">💎</div>
                    <div class="tap-info" id="tap-info">Tap the coin to earn! (0/1000 today)</div>
                </div>
            </div>
        </section>
        
        <!-- Tasks Section -->
        <section id="tasks-section" class="section">
            <div class="container">
                <h1 class="mb-20">🎯 Tasks</h1>
                <div class="tasks-list" id="tasks-list">
                    <!-- Tasks will be populated by JavaScript -->
                </div>
            </div>
        </section>
        
        <!-- Profile Section -->
        <section id="profile-section" class="section">
            <div class="container">
                <div class="profile-header">
                    <div class="profile-pic" id="profile-pic">👤</div>
                    <div class="profile-info">
                        <h2 id="profile-name">User</h2>
                        <div class="profile-id" id="profile-id">ID: ...</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="profile-coins">0</div>
                            <div class="stat-label">Coins</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="profile-level">1</div>
                            <div class="stat-label">Level</div>
                        </div>
                    </div>
                </div>
                
                <div class="referral-section card">
                    <h3>👥 Refer Friends</h3>
                    <p>Earn 500 coins for each friend who joins using your link!</p>
                    <div class="referral-link">
                        <input type="text" id="referral-link" readonly>
                        <button class="btn copy-btn" id="copy-referral">Copy</button>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Withdrawal Section -->
        <section id="withdrawal-section" class="section">
            <div class="container">
                <h1 class="mb-20">💳 Withdraw</h1>
                
                <div class="exchange-rate card">
                    <h3>Exchange Rate</h3>
                    <p id="exchange-rate">1000 Coins = 0.036 USDT</p>
                </div>
                
                <div class="card">
                    <form id="withdrawal-form" class="withdrawal-form">
                        <div class="form-group">
                            <label for="wallet-address">USDT Wallet Address (TRC20)</label>
                            <input type="text" id="wallet-address" placeholder="Enter your TRC20 wallet address" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="withdrawal-amount">Amount to Withdraw</label>
                            <select id="withdrawal-amount">
                                <option value="1000">1000 Coins</option>
                                <option value="5000">5000 Coins</option>
                                <option value="10000">10000 Coins</option>
                            </select>
                            <p id="usdt-equivalent">≈ 0.036 USDT</p>
                        </div>
                        
                        <button type="submit" class="btn">Submit Request</button>
                    </form>
                </div>
                
                <div class="withdrawal-history card">
                    <h3>Withdrawal History</h3>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawal-history">
                            <!-- History will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-section="tap-section">
                <div class="nav-icon">💰</div>
                <div class="nav-label">Tap</div>
            </div>
            <div class="nav-item" data-section="tasks-section">
                <div class="nav-icon">🎯</div>
                <div class="nav-label">Tasks</div>
            </div>
            <div class="nav-item" data-section="profile-section">
                <div class="nav-icon">👤</div>
                <div class="nav-label">Profile</div>
            </div>
            <div class="nav-item" data-section="withdrawal-section">
                <div class="nav-icon">💳</div>
                <div class="nav-label">Withdraw</div>
            </div>
        </nav>
    </div>
    
    <!-- Admin Panel (Hidden in Telegram App) -->
    <div id="admin-panel" class="admin-panel">
        <div class="container">
            <h1>Admin Panel</h1>
            
            <div class="admin-section">
                <h2>Statistics</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-coins">0</div>
                        <div class="stat-label">Total Coins</div>
                    </div>
                </div>
            </div>
            
            <div class="admin-section">
                <h2>Withdrawal Management</h2>
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>User ID</th>
                            <th>Username</th>
                            <th>Amount</th>
                            <th>Wallet</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-withdrawals">
                        <!-- Withdrawals will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="admin-section">
                <h2>Task Management</h2>
                <form id="task-form" class="admin-form">
                    <input type="text" id="task-title" placeholder="Task Title" required>
                    <input type="number" id="task-reward" placeholder="Reward Coins" required>
                    <select id="task-type" required>
                        <option value="url">URL/Visit</option>
                        <option value="channel">Telegram Channel</option>
                        <option value="ad">Watch Ad</option>
                    </select>
                    <input type="text" id="task-target" placeholder="URL or Channel ID" required>
                    <textarea id="task-description" placeholder="Task Description" class="full-width" required></textarea>
                    <button type="submit" class="btn full-width">Add Task</button>
                </form>
                
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Reward</th>
                            <th>Type</th>
                            <th>Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="admin-tasks">
                        <!-- Tasks will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <div class="admin-section">
                <h2>Settings</h2>
                <div class="admin-form">
                    <input type="number" id="exchange-rate-input" placeholder="Exchange Rate (USDT per coin)" step="0.000001" required>
                    <button class="btn full-width" id="update-rate">Update Exchange Rate</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Offline Indicator -->
    <div id="offline-indicator" class="hidden" style="position: fixed; top: 10px; right: 10px; background: #ffa500; color: #000; padding: 5px 10px; border-radius: 5px; z-index: 1001;">
        Offline Mode
    </div>
    
    <script>
        // Firebase Configuration (Replace with your actual config)
        const firebaseConfig = {
  apiKey: "AIzaSyAPoCeD2tC-LVkXGLpm6Whp1HdF3kA18Bg",
  authDomain: "mybota-a1c57.firebaseapp.com",
  projectId: "mybota-a1c57",
  storageBucket: "mybota-a1c57.firebasestorage.app",
  messagingSenderId: "1097209841071",
  appId: "1:1097209841071:web:15832f1359084f8ae99b5a"
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App State
        let userData = {
            telegramId: null,
            username: '',
            profilePic: '',
            coins: 0,
            totalCoins: 0,
            level: 1,
            tapsToday: 0,
            lastTapDate: null,
            referredBy: null
        };

        let conversionRate = 0.000036; // Default exchange rate
        let tasks = [];
        let isOnline = true;
        let pendingActions = [];
        let userWithdrawals = [];

        // DOM Elements
        const appElement = document.getElementById('app');
        const adminPanel = document.getElementById('admin-panel');
        const passwordModal = document.getElementById('password-modal');
        const adminPasswordInput = document.getElementById('admin-password');
        const submitPasswordBtn = document.getElementById('submit-password');
        
        const sections = document.querySelectorAll('.section');
        const navItems = document.querySelectorAll('.nav-item');
        const coinsDisplay = document.getElementById('coins-display');
        const levelDisplay = document.getElementById('level-display');
        const tapCoin = document.getElementById('tap-coin');
        const tapInfo = document.getElementById('tap-info');
        const tasksList = document.getElementById('tasks-list');
        const profilePic = document.getElementById('profile-pic');
        const profileName = document.getElementById('profile-name');
        const profileId = document.getElementById('profile-id');
        const profileCoins = document.getElementById('profile-coins');
        const profileLevel = document.getElementById('profile-level');
        const referralLink = document.getElementById('referral-link');
        const copyReferralBtn = document.getElementById('copy-referral');
        const exchangeRateDisplay = document.getElementById('exchange-rate');
        const withdrawalAmount = document.getElementById('withdrawal-amount');
        const usdtEquivalent = document.getElementById('usdt-equivalent');
        const withdrawalForm = document.getElementById('withdrawal-form');
        const withdrawalHistory = document.getElementById('withdrawal-history');
        const offlineIndicator = document.getElementById('offline-indicator');
        
        // Admin elements
        const totalUsers = document.getElementById('total-users');
        const totalCoins = document.getElementById('total-coins');
        const adminWithdrawals = document.getElementById('admin-withdrawals');
        const taskForm = document.getElementById('task-form');
        const adminTasks = document.getElementById('admin-tasks');
        const exchangeRateInput = document.getElementById('exchange-rate-input');
        const updateRateBtn = document.getElementById('update-rate');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we're in Telegram or a regular browser
            if (window.Telegram && Telegram.WebApp) {
                // Telegram WebApp mode - show normal app
                appElement.style.display = 'block';
                adminPanel.style.display = 'none';
                passwordModal.style.display = 'none';
                initializeTelegramApp();
            } else {
                // Regular browser mode - show password modal for admin access
                appElement.style.display = 'none';
                adminPanel.style.display = 'none';
                passwordModal.style.display = 'flex';
                initializeAdminAccess();
            }
            
            // Initialize navigation
            initializeNavigation();
            
            // Initialize event listeners
            initializeEventListeners();
            
            // Initialize coin animation
            animateCoin();
        });

        // Initialize admin access with password
        function initializeAdminAccess() {
            submitPasswordBtn.addEventListener('click', function() {
                const password = adminPasswordInput.value;
                if (password === 'admin123') { // Hardcoded for demo - change in production!
                    passwordModal.style.display = 'none';
                    adminPanel.style.display = 'block';
                    initializeAdminPanel();
                } else {
                    alert('Invalid password!');
                }
            });
            
            // Also allow Enter key to submit password
            adminPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitPasswordBtn.click();
                }
            });
        }

        // Telegram WebApp Initialization
        function initializeTelegramApp() {
            Telegram.WebApp.ready();
            Telegram.WebApp.expand();
            
            // Get user data from Telegram
            const user = Telegram.WebApp.initDataUnsafe?.user;
            if (user) {
                userData.telegramId = user.id.toString();
                userData.username = user.username || `user_${user.id}`;
                userData.profilePic = user.photo_url || '';
                
                // Update profile display
                updateProfileDisplay();
                
                // Authenticate with Firebase
                authenticateUser();
            } else {
                console.error('Unable to get user data from Telegram');
                // Use mock data for testing
                userData.telegramId = 'test_user_' + Math.floor(Math.random() * 10000);
                userData.username = 'Test User';
                authenticateUser();
            }
            
            // Check for referral parameter
            checkReferral();
        }

        // Check if user was referred
        function checkReferral() {
            const startParam = Telegram.WebApp.initDataUnsafe?.start_param;
            if (startParam && startParam.startsWith('ref_')) {
                const referrerId = startParam.substring(4);
                userData.referredBy = referrerId;
                
                // Credit referrer (this will happen when the user data is saved)
                console.log(`User referred by: ${referrerId}`);
            }
        }

        // Firebase Authentication
        function authenticateUser() {
            // For simplicity, we'll use anonymous auth
            auth.signInAnonymously()
                .then(() => {
                    // User is signed in
                    loadUserData();
                })
                .catch(error => {
                    console.error('Authentication error:', error);
                    // Try to load from cache
                    loadFromCache();
                });
        }

        // Load user data from Firebase with caching
        function loadUserData() {
            // First, try to load from cache for immediate UI response
            loadFromCache();
            
            // Then, try to load from Firebase
            if (userData.telegramId) {
                db.collection('users').doc(userData.telegramId).get()
                    .then(doc => {
                        if (doc.exists) {
                            // User exists, update data
                            const data = doc.data();
                            userData = { ...userData, ...data };
                            
                            // Check if we need to reset daily taps
                            checkDailyReset();
                            
                            // Update UI
                            updateUI();
                            
                            // Save to cache
                            saveToCache();
                        } else {
                            // New user, create document
                            createUserDocument();
                        }
                        
                        // Mark as online
                        setOnlineStatus(true);
                    })
                    .catch(error => {
                        console.error('Error loading user data:', error);
                        // Mark as offline
                        setOnlineStatus(false);
                    });
            }
            
            // Load other data
            loadConversionRate();
            loadTasks();
            loadWithdrawalHistory();
        }

        // Create new user document in Firestore
        function createUserDocument() {
            userData.coins = 100; // Starting bonus
            userData.totalCoins = 100;
            userData.level = 1;
            userData.tapsToday = 0;
            userData.lastTapDate = new Date();
            
            db.collection('users').doc(userData.telegramId).set(userData)
                .then(() => {
                    console.log('User document created');
                    
                    // If referred, credit the referrer
                    if (userData.referredBy) {
                        creditReferrer();
                    }
                    
                    // Update UI
                    updateUI();
                    
                    // Save to cache
                    saveToCache();
                })
                .catch(error => {
                    console.error('Error creating user document:', error);
                });
        }

        // Credit the user who referred this new user
        function creditReferrer() {
            if (!userData.referredBy) return;
            
            const referrerRef = db.collection('users').doc(userData.referredBy);
            db.runTransaction(transaction => {
                return transaction.get(referrerRef).then(doc => {
                    if (!doc.exists) {
                        throw new Error('Referrer does not exist');
                    }
                    
                    const newCoins = (doc.data().coins || 0) + 500;
                    const newTotalCoins = (doc.data().totalCoins || 0) + 500;
                    transaction.update(referrerRef, {
                        coins: newCoins,
                        totalCoins: newTotalCoins
                    });
                });
            }).catch(error => {
                console.error('Error crediting referrer:', error);
            });
        }

        // Load data from localStorage cache
        function loadFromCache() {
            try {
                if (userData.telegramId) {
                    const cached = localStorage.getItem(`tap_earn_user_${userData.telegramId}`);
                    if (cached) {
                        const data = JSON.parse(cached);
                        // Only update if we don't have newer data from Firebase
                        if (!userData.coins || userData.coins < data.coins) {
                            userData = { ...userData, ...data };
                        }
                        updateUI();
                    }
                    
                    // Load withdrawals from cache
                    const cachedWithdrawals = localStorage.getItem(`tap_earn_withdrawals_${userData.telegramId}`);
                    if (cachedWithdrawals) {
                        userWithdrawals = JSON.parse(cachedWithdrawals);
                        renderWithdrawalHistory();
                    }
                }
            } catch (error) {
                console.error('Error loading from cache:', error);
            }
        }

        // Save data to localStorage cache
        function saveToCache() {
            try {
                if (userData.telegramId) {
                    localStorage.setItem(`tap_earn_user_${userData.telegramId}`, JSON.stringify(userData));
                    localStorage.setItem(`tap_earn_withdrawals_${userData.telegramId}`, JSON.stringify(userWithdrawals));
                }
            } catch (error) {
                console.error('Error saving to cache:', error);
            }
        }

        // Check if daily tap counter needs reset
        function checkDailyReset() {
            const now = new Date();
            const lastTapDate = userData.lastTapDate ? 
                (userData.lastTapDate.seconds ? new Date(userData.lastTapDate.seconds * 1000) : new Date(userData.lastTapDate)) : 
                new Date(0);
            
            // Reset if it's a new day
            if (lastTapDate.toDateString() !== now.toDateString()) {
                userData.tapsToday = 0;
                userData.lastTapDate = now;
                
                // Save changes
                updateUserData();
            }
        }

        // Update user data in Firebase
        function updateUserData() {
            if (!userData.telegramId) return;
            
            if (!isOnline) {
                // Queue for later sync
                pendingActions.push({
                    type: 'updateUser',
                    data: userData
                });
                return;
            }
            
            // Always save to cache first for immediate persistence
            saveToCache();
            
            db.collection('users').doc(userData.telegramId).set(userData, { merge: true })
                .then(() => {
                    console.log('User data updated in Firebase');
                })
                .catch(error => {
                    console.error('Error updating user data:', error);
                    // Queue for retry
                    pendingActions.push({
                        type: 'updateUser',
                        data: userData
                    });
                    setOnlineStatus(false);
                });
        }

        // Set online/offline status
        function setOnlineStatus(online) {
            isOnline = online;
            if (online) {
                offlineIndicator.classList.add('hidden');
                // Process any pending actions
                processPendingActions();
            } else {
                offlineIndicator.classList.remove('hidden');
            }
        }

        // Process actions that were queued while offline
        function processPendingActions() {
            const actionsToProcess = [...pendingActions];
            pendingActions = [];
            
            actionsToProcess.forEach(action => {
                switch (action.type) {
                    case 'updateUser':
                        db.collection('users').doc(userData.telegramId).set(action.data, { merge: true })
                            .then(() => {
                                console.log('Pending user update completed');
                            })
                            .catch(error => {
                                console.error('Error processing pending action:', error);
                                // Requeue if failed
                                pendingActions.push(action);
                                setOnlineStatus(false);
                            });
                        break;
                    case 'createWithdrawal':
                        createWithdrawalRequest(action.data);
                        break;
                    // Add other action types as needed
                }
            });
        }

        // Update the UI with current user data
        function updateUI() {
            coinsDisplay.textContent = userData.coins.toLocaleString();
            levelDisplay.textContent = userData.level;
            
            // Update tap info
            const tapsLeft = Math.max(0, 1000 - userData.tapsToday);
            tapInfo.textContent = `Tap the coin to earn! (${userData.tapsToday}/1000 today)`;
            
            // Update profile section
            updateProfileDisplay();
            
            // Update withdrawal equivalent
            updateUsdtEquivalent();
        }

        // Update profile display
        function updateProfileDisplay() {
            if (userData.profilePic) {
                profilePic.innerHTML = `<img src="${userData.profilePic}" alt="Profile" style="width: 100%; height: 100%; border-radius: 50%;">`;
            } else {
                profilePic.textContent = '👤';
            }
            
            profileName.textContent = userData.username || 'User';
            profileId.textContent = `ID: ${userData.telegramId}`;
            profileCoins.textContent = userData.coins.toLocaleString();
            profileLevel.textContent = userData.level;
            
            // Update referral link
            if (userData.telegramId) {
                referralLink.value = `https://t.me/YourBot?start=ref_${userData.telegramId}`;
            }
        }

        // Initialize navigation
        function initializeNavigation() {
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const sectionId = this.getAttribute('data-section');
                    
                    // Update active nav item
                    navItems.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show corresponding section
                    sections.forEach(section => section.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Load withdrawal history when withdrawal section is activated
                    if (sectionId === 'withdrawal-section') {
                        loadWithdrawalHistory();
                    }
                    
                    // Load tasks when tasks section is activated
                    if (sectionId === 'tasks-section') {
                        loadTasks();
                    }
                });
            });
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Tap coin event
            tapCoin.addEventListener('click', handleTap);
            
            // Copy referral link
            copyReferralBtn.addEventListener('click', function() {
                referralLink.select();
                document.execCommand('copy');
                // Show feedback
                const originalText = this.textContent;
                this.textContent = 'Copied!';
                setTimeout(() => {
                    this.textContent = originalText;
                }, 2000);
            });
            
            // Withdrawal amount change
            withdrawalAmount.addEventListener('change', updateUsdtEquivalent);
            
            // Withdrawal form submission
            withdrawalForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const walletAddress = document.getElementById('wallet-address').value;
                const coinAmount = parseInt(withdrawalAmount.value);
                
                if (coinAmount > userData.coins) {
                    alert('Insufficient coins!');
                    return;
                }
                
                submitWithdrawalRequest(walletAddress, coinAmount);
            });
            
            // Admin event listeners
            if (adminPanel.style.display !== 'none') {
                initializeAdminEvents();
            }
        }

        // Handle coin tap
        function handleTap() {
            // Check daily limit
            if (userData.tapsToday >= 1000) {
                alert('Daily tap limit reached! Come back tomorrow.');
                return;
            }
            
            // Update user data
            userData.coins += 1;
            userData.totalCoins += 1;
            userData.tapsToday += 1;
            userData.lastTapDate = new Date();
            
            // Check for level up
            const newLevel = Math.floor(userData.totalCoins / 10000) + 1;
            if (newLevel > userData.level) {
                userData.level = newLevel;
                // Optional: Add level up bonus
                userData.coins += 1000;
                userData.totalCoins += 1000;
                alert(`Level Up! You reached level ${newLevel} and received 1000 bonus coins!`);
            }
            
            // Update UI
            updateUI();
            
            // Save to cache and Firebase
            saveToCache();
            updateUserData();
            
            // Create tap feedback animation
            createTapFeedback();
        }

        // Create tap feedback animation
        function createTapFeedback() {
            const feedback = document.createElement('div');
            feedback.className = 'tap-feedback';
            feedback.textContent = '+1';
            feedback.style.left = `${event.clientX}px`;
            feedback.style.top = `${event.clientY}px`;
            document.body.appendChild(feedback);
            
            // Remove after animation
            setTimeout(() => {
                document.body.removeChild(feedback);
            }, 1000);
        }

        // Animate the coin
        function animateCoin() {
            tapCoin.style.animation = 'bounce 2s infinite';
        }

        // Load conversion rate from Firebase
        function loadConversionRate() {
            db.collection('app').doc('settings').get()
                .then(doc => {
                    if (doc.exists && doc.data().conversionRate) {
                        conversionRate = doc.data().conversionRate;
                        updateExchangeRateDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error loading conversion rate:', error);
                });
        }

        // Update USDT equivalent display
        function updateUsdtEquivalent() {
            const amount = parseInt(withdrawalAmount.value);
            const usdtValue = amount * conversionRate;
            usdtEquivalent.textContent = `≈ ${usdtValue.toFixed(6)} USDT`;
        }

        // Update exchange rate display
        function updateExchangeRateDisplay() {
            const usdtValue = 1000 * conversionRate;
            exchangeRateDisplay.textContent = `1000 Coins = ${usdtValue.toFixed(6)} USDT`;
            if (exchangeRateInput) {
                exchangeRateInput.value = conversionRate;
            }
        }

        // Load tasks from Firebase
        function loadTasks() {
            db.collection('tasks').where('isActive', '==', true).get()
                .then(querySnapshot => {
                    tasks = [];
                    querySnapshot.forEach(doc => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    renderTasks();
                })
                .catch(error => {
                    console.error('Error loading tasks:', error);
                    // Try to load from cache if online fails
                    const cachedTasks = localStorage.getItem('tap_earn_tasks');
                    if (cachedTasks) {
                        tasks = JSON.parse(cachedTasks);
                        renderTasks();
                    }
                });
        }

        // Render tasks in the UI
        function renderTasks() {
            tasksList.innerHTML = '';
            
            if (tasks.length === 0) {
                tasksList.innerHTML = '<div class="card text-center">No tasks available at the moment. Check back later!</div>';
                return;
            }
            
            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-card';
                
                let buttonText = 'Start';
                let buttonAction = '';
                
                switch (task.type) {
                    case 'url':
                        buttonAction = `window.open('${task.target}', '_blank')`;
                        break;
                    case 'channel':
                        buttonAction = `openTelegramChannel('${task.target}')`;
                        buttonText = 'Join';
                        break;
                    case 'ad':
                        buttonAction = `watchAd('${task.id}')`;
                        buttonText = 'Watch';
                        break;
                }
                
                taskElement.innerHTML = `
                    <div class="task-info">
                        <div class="task-title">${task.title} <span class="task-reward">+${task.reward}</span></div>
                        <div class="task-description">${task.description}</div>
                    </div>
                    <button class="btn" onclick="${buttonAction}">${buttonText}</button>
                `;
                
                tasksList.appendChild(taskElement);
            });
            
            // Cache tasks for offline use
            localStorage.setItem('tap_earn_tasks', JSON.stringify(tasks));
        }

        // Open Telegram channel
        function openTelegramChannel(channelId) {
            if (window.Telegram && Telegram.WebApp) {
                Telegram.WebApp.openTelegramLink(`https://t.me/${channelId}`);
                // In a real app, you would need to implement verification
                setTimeout(() => {
                    if (confirm('Have you joined the channel?')) {
                        completeTask('channel', channelId);
                    }
                }, 3000);
            } else {
                window.open(`https://t.me/${channelId}`, '_blank');
            }
        }

        // Watch ad (mock implementation)
        function watchAd(taskId) {
            // Simulate ad display
            if (confirm('Watch a short ad to earn coins?')) {
                setTimeout(() => {
                    completeTask('ad', taskId);
                }, 3000);
            }
        }

        // Complete a task and reward user
        function completeTask(type, identifier) {
            // Find the task
            const task = tasks.find(t => 
                (type === 'channel' && t.type === 'channel' && t.target === identifier) ||
                (type === 'ad' && t.id === identifier)
            );
            
            if (!task) return;
            
            // Reward user
            userData.coins += task.reward;
            userData.totalCoins += task.reward;
            
            // Update UI
            updateUI();
            
            // Save to cache and Firebase
            saveToCache();
            updateUserData();
            
            alert(`Task completed! You earned ${task.reward} coins.`);
        }

        // Submit withdrawal request
        function submitWithdrawalRequest(walletAddress, coinAmount) {
            const usdtValue = coinAmount * conversionRate;
            
            // Check if user has enough coins
            if (userData.coins < coinAmount) {
                alert('Insufficient coins for this withdrawal!');
                return;
            }
            
            // Deduct coins immediately
            userData.coins -= coinAmount;
            updateUI();
            
            // Save user data
            saveToCache();
            updateUserData();
            
            const withdrawalData = {
                userId: userData.telegramId,
                username: userData.username,
                walletAddress: walletAddress,
                coinAmount: coinAmount,
                usdtValue: usdtValue,
                status: 'Pending',
                timestamp: new Date()
            };
            
            // Add to local history immediately
            userWithdrawals.unshift(withdrawalData);
            renderWithdrawalHistory();
            saveToCache();
            
            if (!isOnline) {
                pendingActions.push({
                    type: 'createWithdrawal',
                    data: withdrawalData
                });
                alert('Withdrawal request queued. It will be submitted when online.');
                withdrawalForm.reset();
                return;
            }
            
            createWithdrawalRequest(withdrawalData);
        }

        // Create withdrawal request in Firebase
        function createWithdrawalRequest(withdrawalData) {
            db.collection('withdrawals').add(withdrawalData)
                .then((docRef) => {
                    // Update local record with Firebase ID
                    const index = userWithdrawals.findIndex(w => 
                        w.timestamp.getTime() === withdrawalData.timestamp.getTime()
                    );
                    if (index !== -1) {
                        userWithdrawals[index].id = docRef.id;
                        renderWithdrawalHistory();
                        saveToCache();
                    }
                    
                    alert('Withdrawal request submitted successfully!');
                    withdrawalForm.reset();
                })
                .catch(error => {
                    console.error('Error creating withdrawal request:', error);
                    // Refund coins if submission failed
                    userData.coins += withdrawalData.coinAmount;
                    updateUI();
                    updateUserData();
                    
                    // Remove from local history
                    const index = userWithdrawals.findIndex(w => 
                        w.timestamp.getTime() === withdrawalData.timestamp.getTime()
                    );
                    if (index !== -1) {
                        userWithdrawals.splice(index, 1);
                        renderWithdrawalHistory();
                        saveToCache();
                    }
                    
                    alert('Error submitting withdrawal request. Coins have been refunded. Please try again.');
                });
        }

        // Load withdrawal history
        function loadWithdrawalHistory() {
            if (!userData.telegramId) return;
            
            // First load from cache for immediate display
            renderWithdrawalHistory();
            
            // Then try to load from Firebase
            db.collection('withdrawals')
                .where('userId', '==', userData.telegramId)
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    userWithdrawals = [];
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        data.id = doc.id;
                        // Convert Firestore timestamp to Date
                        data.timestamp = data.timestamp.toDate();
                        userWithdrawals.push(data);
                    });
                    renderWithdrawalHistory();
                    saveToCache();
                })
                .catch(error => {
                    console.error('Error loading withdrawal history:', error);
                    // Continue with cached data
                });
        }

        // Render withdrawal history in the UI
        function renderWithdrawalHistory() {
            withdrawalHistory.innerHTML = '';
            
            if (userWithdrawals.length === 0) {
                withdrawalHistory.innerHTML = '<tr><td colspan="3" style="text-align: center;">No withdrawal history</td></tr>';
                return;
            }
            
            userWithdrawals.forEach(withdrawal => {
                const date = withdrawal.timestamp.toLocaleDateString();
                const statusClass = `status-${withdrawal.status.toLowerCase()}`;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${withdrawal.coinAmount} coins</td>
                    <td class="${statusClass}">${withdrawal.status}</td>
                `;
                withdrawalHistory.appendChild(row);
            });
        }

        // Admin Panel Functions
        function initializeAdminPanel() {
            loadAdminStatistics();
            loadAdminWithdrawals();
            loadAdminTasks();
            initializeAdminEvents();
            
            // Set up real-time listeners for admin panel
            setupAdminRealTimeListeners();
        }

        function setupAdminRealTimeListeners() {
            // Real-time listener for withdrawals
            db.collection('withdrawals')
                .orderBy('timestamp', 'desc')
                .onSnapshot(querySnapshot => {
                    loadAdminWithdrawals();
                });
            
            // Real-time listener for tasks
            db.collection('tasks')
                .onSnapshot(querySnapshot => {
                    loadAdminTasks();
                });
            
            // Real-time listener for users
            db.collection('users')
                .onSnapshot(querySnapshot => {
                    loadAdminStatistics();
                });
        }

        function initializeAdminEvents() {
            // Task form submission
            taskForm.addEventListener('submit', function(e) {
                e.preventDefault();
                addTask();
            });
            
            // Update exchange rate
            updateRateBtn.addEventListener('click', function() {
                updateExchangeRate();
            });
        }

        function loadAdminStatistics() {
            // Load total users
            db.collection('users').get()
                .then(querySnapshot => {
                    totalUsers.textContent = querySnapshot.size;
                    
                    // Calculate total coins
                    let total = 0;
                    querySnapshot.forEach(doc => {
                        total += doc.data().coins || 0;
                    });
                    totalCoins.textContent = total.toLocaleString();
                })
                .catch(error => {
                    console.error('Error loading admin statistics:', error);
                });
        }

        function loadAdminWithdrawals() {
            db.collection('withdrawals')
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    adminWithdrawals.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        adminWithdrawals.innerHTML = '<tr><td colspan="7" style="text-align: center;">No withdrawal requests</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        const date = data.timestamp.toDate().toLocaleDateString();
                        const statusClass = `status-${data.status.toLowerCase()}`;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.userId}</td>
                            <td>${data.username || 'N/A'}</td>
                            <td>${data.coinAmount} coins</td>
                            <td>${data.walletAddress}</td>
                            <td>${date}</td>
                            <td class="${statusClass}">${data.status}</td>
                            <td>
                                ${data.status === 'Pending' ? `
                                    <button class="btn" onclick="approveWithdrawal('${doc.id}', ${data.coinAmount}, '${data.userId}')">Approve</button>
                                    <button class="btn btn-secondary" onclick="rejectWithdrawal('${doc.id}', '${data.userId}', ${data.coinAmount})">Reject</button>
                                ` : 'No actions'}
                            </td>
                        `;
                        adminWithdrawals.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading admin withdrawals:', error);
                });
        }

        function loadAdminTasks() {
            db.collection('tasks').get()
                .then(querySnapshot => {
                    adminTasks.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        adminTasks.innerHTML = '<tr><td colspan="5" style="text-align: center;">No tasks</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${data.title}</td>
                            <td>${data.reward}</td>
                            <td>${data.type}</td>
                            <td>${data.isActive ? 'Yes' : 'No'}</td>
                            <td>
                                <button class="btn" onclick="toggleTask('${doc.id}', ${!data.isActive})">${data.isActive ? 'Deactivate' : 'Activate'}</button>
                                <button class="btn btn-secondary" onclick="deleteTask('${doc.id}')">Delete</button>
                            </td>
                        `;
                        adminTasks.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading admin tasks:', error);
                });
        }

        function addTask() {
            const title = document.getElementById('task-title').value;
            const description = document.getElementById('task-description').value;
            const reward = parseInt(document.getElementById('task-reward').value);
            const type = document.getElementById('task-type').value;
            const target = document.getElementById('task-target').value;
            
            const taskData = {
                title: title,
                description: description,
                reward: reward,
                type: type,
                target: target,
                isActive: true
            };
            
            db.collection('tasks').add(taskData)
                .then(() => {
                    alert('Task added successfully!');
                    taskForm.reset();
                    // No need to call loadAdminTasks() here because real-time listener will update
                })
                .catch(error => {
                    console.error('Error adding task:', error);
                    alert('Error adding task. Please try again.');
                });
        }

        function updateExchangeRate() {
            const newRate = parseFloat(exchangeRateInput.value);
            
            if (isNaN(newRate) || newRate <= 0) {
                alert('Please enter a valid exchange rate');
                return;
            }
            
            db.collection('app').doc('settings').set({
                conversionRate: newRate
            }, { merge: true })
            .then(() => {
                conversionRate = newRate;
                updateExchangeRateDisplay();
                alert('Exchange rate updated successfully!');
            })
            .catch(error => {
                console.error('Error updating exchange rate:', error);
                alert('Error updating exchange rate. Please try again.');
            });
        }

        // These functions would be called from the admin panel buttons
        window.approveWithdrawal = function(withdrawalId, coinAmount, userId) {
            // Update withdrawal status to approved
            db.collection('withdrawals').doc(withdrawalId).update({
                status: 'Approved'
            })
            .then(() => {
                alert('Withdrawal approved!');
                // No need to call loadAdminWithdrawals() here because real-time listener will update
            })
            .catch(error => {
                console.error('Error approving withdrawal:', error);
                alert('Error approving withdrawal. Please try again.');
            });
        };

        window.rejectWithdrawal = function(withdrawalId, userId, coinAmount) {
            // First get the withdrawal data to refund coins
            db.collection('withdrawals').doc(withdrawalId).get()
                .then(doc => {
                    if (!doc.exists) return;
                    
                    const data = doc.data();
                    
                    // Refund coins to user
                    return db.collection('users').doc(userId).update({
                        coins: firebase.firestore.FieldValue.increment(coinAmount)
                    })
                    .then(() => {
                        // Update withdrawal status to rejected
                        return db.collection('withdrawals').doc(withdrawalId).update({
                            status: 'Rejected'
                        });
                    });
                })
                .then(() => {
                    alert('Withdrawal rejected and coins refunded!');
                    // No need to call loadAdminWithdrawals() here because real-time listener will update
                })
                .catch(error => {
                    console.error('Error rejecting withdrawal:', error);
                    alert('Error rejecting withdrawal. Please try again.');
                });
        };

        window.toggleTask = function(taskId, newStatus) {
            db.collection('tasks').doc(taskId).update({
                isActive: newStatus
            })
            .then(() => {
                alert(`Task ${newStatus ? 'activated' : 'deactivated'}!`);
                // No need to call loadAdminTasks() here because real-time listener will update
            })
            .catch(error => {
                console.error('Error toggling task:', error);
                alert('Error toggling task. Please try again.');
            });
        };

        window.deleteTask = function(taskId) {
            if (confirm('Are you sure you want to delete this task?')) {
                db.collection('tasks').doc(taskId).delete()
                .then(() => {
                    alert('Task deleted!');
                    // No need to call loadAdminTasks() here because real-time listener will update
                })
                .catch(error => {
                    console.error('Error deleting task:', error);
                    alert('Error deleting task. Please try again.');
                });
            }
        };
    </script>
</body>
</html>