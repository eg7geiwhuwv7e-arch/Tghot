<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperAirDrop</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Ad SDK Implementation -->
    <script src='//libtl.com/sdk.js' data-zone='10001127' data-sdk='show_10001127'></script>
    <style>
        :root {
            --primary: #6C63FF;
            --primary-dark: #5a52d5;
            --secondary: #FF6584;
            --background: #f8f9fa;
            --surface: #ffffff;
            --on-surface: #333333;
            --on-surface-secondary: #666666;
            --border: #e0e0e0;
            --success: #4CAF50;
            --warning: #FF9800;
            --error: #f44336;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --background: #121212;
            --surface: #1e1e1e;
            --on-surface: #ffffff;
            --on-surface-secondary: #aaaaaa;
            --border: #333333;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background);
            color: var(--on-surface);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* Panel Containers */
        #user-panel, #admin-panel {
            display: none;
            min-height: 100vh;
            padding-bottom: 70px; /* Space for bottom nav */
        }

        /* User Panel Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: var(--surface);
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-name {
            font-weight: 600;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .balance-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .balance-amount {
            font-size: 32px;
            font-weight: bold;
            margin: 8px 0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-label {
            font-size: 12px;
            color: var(--on-surface-secondary);
            margin-top: 4px;
        }

        .chart-container {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .action-btn {
            flex: 1;
            background-color: var(--surface);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
            box-shadow: var(--shadow);
            font-weight: 500;
        }

        .screen {
            display: none;
            padding: 16px;
        }

        .screen.active {
            display: block;
        }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--surface);
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--on-surface-secondary);
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-icon {
            font-size: 20px;
        }

        .task-card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .task-title {
            font-weight: 600;
        }

        .task-reward {
            color: var(--success);
            font-weight: 600;
        }

        .task-description {
            color: var(--on-surface-secondary);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:disabled {
            background-color: var(--on-surface-secondary);
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: var(--surface);
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-error {
            background-color: var(--error);
            color: white;
        }

        .progress-container {
            margin-bottom: 16px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--border);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary);
        }

        .leaderboard-tabs {
            display: flex;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .tab {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
        }

        .tab.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .leaderboard-rank {
            width: 40px;
            text-align: center;
            font-weight: bold;
            margin-right: 12px;
            font-size: 16px;
        }

        .leaderboard-rank-gold {
            color: gold;
        }

        .leaderboard-rank-silver {
            color: silver;
        }

        .leaderboard-rank-bronze {
            color: #cd7f32;
        }

        .leaderboard-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 12px;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-weight: 500;
            font-size: 16px;
        }

        .leaderboard-value {
            font-weight: bold;
            color: var(--primary);
            font-size: 16px;
        }

        .profile-section {
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .referral-link-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .referral-link {
            flex: 1;
            background-color: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .withdrawal-form {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background-color: var(--background);
            color: var(--on-surface);
        }

        .withdrawal-history {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .withdrawal-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }

        .withdrawal-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-pending {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .status-approved {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .status-rejected {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error);
        }

        /* Admin Panel Styles */
        .admin-login {
            max-width: 400px;
            margin: 100px auto;
            padding: 24px;
            background-color: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: var(--surface);
            box-shadow: var(--shadow);
            margin-bottom: 16px;
        }

        .admin-nav {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .admin-nav-item {
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 500;
        }

        .admin-nav-item.active {
            border-bottom: 2px solid var(--primary);
            color: var(--primary);
        }

        .admin-section {
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .admin-stat-card {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .admin-stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
        }

        .admin-stat-label {
            font-size: 14px;
            color: var(--on-surface-secondary);
            margin-top: 4px;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .admin-table th, .admin-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .admin-table th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }

        .admin-form {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--on-surface);
            font-size: 20px;
            cursor: pointer;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--surface);
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--on-surface);
            cursor: pointer;
        }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .quick-actions {
                flex-direction: row;
            }
        }
    </style>
</head>
<body>
    <!-- User Panel (Telegram Mini App) -->
    <div id="user-panel">
        <div class="header">
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">U</div>
                <div>
                    <div class="user-name" id="user-name">User</div>
                    <div style="font-size: 12px; color: var(--on-surface-secondary);" id="user-id">ID: ...</div>
                </div>
            </div>
            <button class="theme-toggle" id="theme-toggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <div class="container">
            <!-- Home Screen -->
            <div class="screen active" id="home-screen">
                <div class="balance-card">
                    <div class="balance-label">Main Balance</div>
                    <div class="balance-amount" id="main-balance">0.00 USDT</div>
                    <div style="font-size: 14px;">Total Earnings: <span id="total-income">0.00 USDT</span></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="today-ads">0/20</div>
                        <div class="stat-label">Today's Ads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-referrals">0</div>
                        <div class="stat-label">Total Referrals</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-ads">0</div>
                        <div class="stat-label">Total Ads</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="weekly-earnings">0.00 USDT</div>
                        <div class="stat-label">This Week</div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-title">Weekly Earnings</div>
                    <canvas id="earnings-chart" height="150"></canvas>
                </div>

                <div class="quick-actions">
                    <div class="action-btn">
                        <i class="fab fa-telegram" style="color: var(--primary); margin-bottom: 4px;"></i>
                        <div>Join Community</div>
                    </div>
                    <div class="action-btn">
                        <i class="fab fa-twitter" style="color: var(--primary); margin-bottom: 4px;"></i>
                        <div>Follow on X</div>
                    </div>
                </div>
            </div>

            <!-- Tasks Screen -->
            <div class="screen" id="tasks-screen">
                <!-- Daily Ad Progress Card (Updated) -->
                <div class="task-card">
                    <div class="task-header">
                        <div class="task-title">Daily Ad Progress</div>
                        <div class="task-reward" id="ad-progress">0/20</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Watch ads to earn USDT</span>
                            <span id="ad-reward">+0.001 USDT</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="ad-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                    <button class="btn btn-primary" id="watch-ad-btn">
                        Watch Ad
                    </button>
                </div>

                <div class="section-title">Bonus Tasks</div>
                <div id="bonus-tasks-container">
                    <!-- Bonus tasks will be loaded here -->
                </div>
            </div>

            <!-- Leaderboard Screen -->
            <div class="screen" id="leaderboard-screen">
                <div class="leaderboard-tabs">
                    <div class="tab active" data-tab="referrers">Top Referrers</div>
                    <div class="tab" data-tab="earners">Top Earners</div>
                </div>

                <div id="referrers-leaderboard">
                    <!-- Top referrers will be loaded here -->
                </div>

                <div id="earners-leaderboard" style="display: none;">
                    <!-- Top earners will be loaded here -->
                </div>
            </div>

            <!-- Profile Screen -->
            <div class="screen" id="profile-screen">
                <div class="profile-section">
                    <div class="section-title">Invite Friends & Earn</div>
                    <div class="task-card">
                        <div class="task-description">
                            Invite your friends and earn <span id="referral-bonus">0.010</span> USDT for each successful referral!
                        </div>
                        <div class="referral-link-container">
                            <input type="text" class="referral-link" id="referral-link" readonly value="Loading...">
                            <button class="btn btn-primary" id="copy-link-btn">Copy</button>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="section-title">Withdraw Funds</div>
                    <div class="task-card">
                        <div class="task-description" id="withdrawal-conditions">
                            You need at least <span id="min-withdrawal-refs">10</span> referrals and minimum <span id="min-withdrawal-amount">2</span> USDT to withdraw.
                        </div>
                        <button class="btn btn-primary" id="withdraw-btn">Request Withdraw</button>
                    </div>
                </div>

                <div class="profile-section">
                    <div class="section-title">Withdrawal History</div>
                    <div class="withdrawal-history" id="withdrawal-history">
                        <!-- Withdrawal history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <div class="nav-item active" data-screen="home-screen">
                <i class="fas fa-home nav-icon"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" data-screen="tasks-screen">
                <i class="fas fa-tasks nav-icon"></i>
                <span>Tasks</span>
            </div>
            <div class="nav-item" data-screen="leaderboard-screen">
                <i class="fas fa-trophy nav-icon"></i>
                <span>Leaderboard</span>
            </div>
            <div class="nav-item" data-screen="profile-screen">
                <i class="fas fa-user nav-icon"></i>
                <span>Profile</span>
            </div>
        </div>
    </div>

    <!-- Admin Panel (Browser View) -->
    <div id="admin-panel">
        <div id="admin-login-container">
            <div class="admin-login">
                <h2 style="text-align: center; margin-bottom: 24px;">SuperAirDrop Admin</h2>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="admin-email" placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="admin-password" placeholder="Enter password">
                </div>
                <button class="btn btn-primary" style="width: 100%;" id="admin-login-btn">Login</button>
            </div>
        </div>

        <div id="admin-dashboard" style="display: none;">
            <div class="admin-header">
                <h2>SuperAirDrop Admin</h2>
                <div>
                    <button class="theme-toggle" id="admin-theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="btn btn-secondary" id="admin-logout-btn">Logout</button>
                </div>
            </div>

            <div class="container">
                <div class="admin-nav">
                    <div class="admin-nav-item active" data-section="dashboard">Dashboard</div>
                    <div class="admin-nav-item" data-section="users">User Management</div>
                    <div class="admin-nav-item" data-section="tasks">Task Management</div>
                    <div class="admin-nav-item" data-section="withdrawals">Withdrawal Management</div>
                    <div class="admin-nav-item" data-section="config">App Configuration</div>
                </div>

                <!-- Dashboard Section -->
                <div class="admin-section active" id="dashboard-section">
                    <div class="admin-stats">
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="total-users">0</div>
                            <div class="admin-stat-label">Total Users</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="total-usdt-earned">0 USDT</div>
                            <div class="admin-stat-label">Total USDT Earned</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="pending-withdrawals">0</div>
                            <div class="admin-stat-label">Pending Withdrawals</div>
                        </div>
                        <div class="admin-stat-card">
                            <div class="admin-stat-value" id="approved-withdrawals">0</div>
                            <div class="admin-stat-label">Approved Withdrawals</div>
                        </div>
                    </div>
                </div>

                <!-- User Management Section -->
                <div class="admin-section" id="users-section">
                    <div class="form-group">
                        <input type="text" class="form-input" id="user-search" placeholder="Search users...">
                    </div>
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Username</th>
                                <th>Main Balance</th>
                                <th>Referrals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Task Management Section -->
                <div class="admin-section" id="tasks-section">
                    <div class="admin-form">
                        <h3 style="margin-bottom: 16px;">Add New Task</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Task Title</label>
                                <input type="text" class="form-input" id="task-title">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Reward Amount (USDT)</label>
                                <input type="number" class="form-input" id="task-reward" step="0.01">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-input" id="task-description" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">URL/Instruction</label>
                            <input type="text" class="form-input" id="task-url">
                        </div>
                        <button class="btn btn-primary" id="add-task-btn">Add Task</button>
                    </div>

                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Reward</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tasks-table-body">
                            <!-- Tasks will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Withdrawal Management Section -->
                <div class="admin-section" id="withdrawals-section">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Username</th>
                                <th>Amount</th>
                                <th>Wallet Address</th>
                                <th>Method</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="withdrawals-table-body">
                            <!-- Withdrawals will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- App Configuration Section -->
                <div class="admin-section" id="config-section">
                    <div class="admin-form">
                        <h3 style="margin-bottom: 16px;">App Configuration</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Daily Ad Reward (USDT)</label>
                                <input type="number" class="form-input" id="daily-ad-reward" step="0.001" value="0.001">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Daily Ad Limit</label>
                                <input type="number" class="form-input" id="daily-ad-limit" value="20">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Referral Bonus (USDT)</label>
                                <input type="number" class="form-input" id="referral-bonus-config" step="0.001" value="0.010">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Min Withdrawal Amount (USDT)</label>
                                <input type="number" class="form-input" id="min-withdrawal-amount-config" step="0.01" value="2">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Min Withdrawal Referrals</label>
                                <input type="number" class="form-input" id="min-withdrawal-refs-config" value="10">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Withdrawal Methods (JSON)</label>
                            <textarea class="form-input" id="withdrawal-methods" rows="4"></textarea>
                        </div>
                        <button class="btn btn-primary" id="save-config-btn">Save Configuration</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Ad Watching -->
    <div class="modal" id="ad-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Watch Ad</div>
                <button class="modal-close" id="close-ad-modal">&times;</button>
            </div>
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 18px; margin-bottom: 16px;">Watching advertisement...</div>
                <div id="ad-status" style="margin-bottom: 20px;">Please wait while the ad loads.</div>
                <button class="btn btn-primary" id="skip-ad-btn" style="display: none;">Skip Ad</button>
            </div>
        </div>
    </div>

    <!-- Modal for Withdrawal -->
    <div class="modal" id="withdrawal-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Request Withdrawal</div>
                <button class="modal-close" id="close-withdrawal-modal">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Withdrawal Method</label>
                <select class="form-select" id="withdrawal-method">
                    <option value="">Select method</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Wallet Address/ID</label>
                <input type="text" class="form-input" id="withdrawal-address" placeholder="Enter your wallet address or payment ID">
            </div>
            <div class="form-group">
                <label class="form-label">Amount (USDT)</label>
                <input type="number" class="form-input" id="withdrawal-amount" placeholder="Enter amount" min="2" step="0.01">
                <div style="font-size: 12px; margin-top: 4px;">Available: <span id="available-balance">0.00</span> USDT | Minimum: 2 USDT</div>
            </div>
            <button class="btn btn-primary" style="width: 100%;" id="submit-withdrawal-btn">Submit Request</button>
        </div>
    </div>

    <!-- Modal for User Edit -->
    <div class="modal" id="user-edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Edit User</div>
                <button class="modal-close" id="close-user-edit-modal">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">User ID</label>
                <input type="text" class="form-input" id="edit-user-id" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" class="form-input" id="edit-username" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">Main Balance (USDT)</label>
                <input type="number" class="form-input" id="edit-main-balance" step="0.001">
            </div>
            <div class="form-group">
                <label class="form-label">Referrals</label>
                <input type="number" class="form-input" id="edit-referrals">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" id="save-user-btn">Save Changes</button>
                <button class="btn btn-error" id="ban-user-btn">Ban User</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
  apiKey: "AIzaSyDOMdnCV2hXOveocXtEnnwICzJjp0Bb4Mg",
  authDomain: "superairdrop-90c6d.firebaseapp.com",
  projectId: "superairdrop-90c6d",
  storageBucket: "superairdrop-90c6d.firebasestorage.app",
  messagingSenderId: "623122845001",
  appId: "1:623122845001:web:5b0758778b7424dbf75e98"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Global variables
        let currentUser = null;
        let appConfig = {};
        let telegramUser = null;
        let isAdmin = false;
        let weeklyEarnings = [0, 0, 0, 0, 0, 0, 0]; // Weekly earnings data

        // DOM Elements
        const userPanel = document.getElementById('user-panel');
        const adminPanel = document.getElementById('admin-panel');
        const adminLoginContainer = document.getElementById('admin-login-container');
        const adminDashboard = document.getElementById('admin-dashboard');

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupEventListeners();
        });

        // Initialize the application
        function initApp() {
            // Check if we're in Telegram or browser environment
            if (window.Telegram && window.Telegram.WebApp) {
                // Telegram Mini App environment - show user panel
                userPanel.style.display = 'block';
                adminPanel.style.display = 'none';
                initTelegramApp();
            } else {
                // Browser environment - show admin panel
                userPanel.style.display = 'none';
                adminPanel.style.display = 'block';
                initAdminApp();
            }

            // Load app configuration
            loadAppConfig();
        }

        // Initialize Telegram Mini App
        function initTelegramApp() {
            const tg = window.Telegram.WebApp;
            tg.expand();
            
            // Get Telegram user data
            telegramUser = tg.initDataUnsafe.user;
            
            if (telegramUser) {
                // Update UI with user data
                document.getElementById('user-avatar').textContent = telegramUser.first_name ? telegramUser.first_name[0] : 'U';
                document.getElementById('user-name').textContent = telegramUser.first_name || 'User';
                document.getElementById('user-id').textContent = `ID: ${telegramUser.id}`;
                
                // Initialize or get user data from Firestore
                initUserData(telegramUser.id, telegramUser.username, telegramUser.first_name);
            } else {
                // Fallback for testing outside Telegram
                document.getElementById('user-avatar').textContent = 'T';
                document.getElementById('user-name').textContent = 'Test User';
                document.getElementById('user-id').textContent = 'ID: 123456';
                initUserData('123456', 'testuser', 'Test User');
            }
        }

        // Initialize Admin App
        function initAdminApp() {
            // Check if admin is already logged in
            const adminUser = localStorage.getItem('adminUser');
            if (adminUser) {
                showAdminDashboard();
            } else {
                showAdminLogin();
            }
        }

        // Initialize or get user data from Firestore
        function initUserData(userId, username, firstName) {
            const userRef = db.collection('users').doc(userId.toString());
            
            userRef.get().then((doc) => {
                if (doc.exists) {
                    // User exists, load their data
                    currentUser = { id: userId, ...doc.data() };
                    updateUserUI();
                    loadWeeklyEarnings();
                } else {
                    // New user, create document
                    const userData = {
                        userId: userId,
                        username: username || '',
                        firstName: firstName || 'User',
                        mainBalance: 0,
                        referrals: 0,
                        totalAdsWatched: 0,
                        todayAdsWatched: 0,
                        lastAdWatchTimestamp: null,
                        completedBonusTasks: [],
                        joinDate: firebase.firestore.FieldValue.serverTimestamp(),
                        isBanned: false,
                        weeklyEarnings: [0, 0, 0, 0, 0, 0, 0], // Initialize weekly earnings
                        lastEarningUpdate: new Date().toISOString().split('T')[0] // Today's date
                    };
                    
                    userRef.set(userData).then(() => {
                        currentUser = { id: userId, ...userData };
                        weeklyEarnings = userData.weeklyEarnings;
                        updateUserUI();
                        initEarningsChart();
                    });
                }
            }).catch((error) => {
                console.error('Error getting user data:', error);
            });
        }

        // Update user UI with current data
        function updateUserUI() {
            if (!currentUser) return;
            
            // Update balances
            document.getElementById('main-balance').textContent = currentUser.mainBalance.toFixed(3) + ' USDT';
            document.getElementById('total-income').textContent = (currentUser.mainBalance).toFixed(3) + ' USDT';
            
            // Update stats
            document.getElementById('today-ads').textContent = (currentUser.todayAdsWatched || 0) + '/20';
            document.getElementById('total-referrals').textContent = currentUser.referrals || 0;
            document.getElementById('total-ads').textContent = currentUser.totalAdsWatched || 0;
            
            // Calculate weekly earnings
            const weeklyTotal = weeklyEarnings.reduce((sum, val) => sum + val, 0);
            document.getElementById('weekly-earnings').textContent = weeklyTotal.toFixed(3) + ' USDT';
            
            // Update ad progress
            const todayAds = currentUser.todayAdsWatched || 0;
            const dailyLimit = 20;
            const progressPercent = (todayAds / dailyLimit) * 100;
            document.getElementById('ad-progress').textContent = `${todayAds}/${dailyLimit}`;
            document.getElementById('ad-progress-bar').style.width = `${progressPercent}%`;
            
            // Update watch ad button state
            const watchAdBtn = document.getElementById('watch-ad-btn');
            if (todayAds >= dailyLimit) {
                watchAdBtn.disabled = true;
                watchAdBtn.textContent = 'Daily Limit Reached';
            } else {
                watchAdBtn.disabled = false;
                watchAdBtn.textContent = 'Watch Ad';
            }
            
            // Update referral link
            const referralLink = `https://t.me/YourBotUsername/SuperAirDrop?startapp=ref_${currentUser.id}`;
            document.getElementById('referral-link').value = referralLink;
            
            // Update withdrawal conditions
            document.getElementById('min-withdrawal-refs').textContent = '10';
            document.getElementById('min-withdrawal-amount').textContent = '2';
            
            // Load bonus tasks
            loadBonusTasks();
            
            // Load leaderboard
            loadLeaderboard('referrers');
            
            // Load withdrawal history
            loadWithdrawalHistory();
        }

        // Load weekly earnings data
        function loadWeeklyEarnings() {
            if (!currentUser) return;
            
            // Check if we need to reset weekly earnings (new week)
            const today = new Date().toISOString().split('T')[0];
            if (currentUser.lastEarningUpdate !== today) {
                // Check if it's a new week (Monday)
                const todayDate = new Date();
                const lastUpdateDate = new Date(currentUser.lastEarningUpdate);
                const isNewWeek = todayDate.getDay() === 1 && todayDate.getDate() !== lastUpdateDate.getDate();
                
                if (isNewWeek) {
                    // Reset weekly earnings for new week
                    weeklyEarnings = [0, 0, 0, 0, 0, 0, 0];
                    
                    // Update user data in Firestore
                    const userRef = db.collection('users').doc(currentUser.id.toString());
                    userRef.update({
                        weeklyEarnings: weeklyEarnings,
                        lastEarningUpdate: today
                    }).then(() => {
                        currentUser.weeklyEarnings = weeklyEarnings;
                        currentUser.lastEarningUpdate = today;
                        updateUserUI();
                        initEarningsChart();
                    });
                } else {
                    // Just update the date
                    weeklyEarnings = currentUser.weeklyEarnings || [0, 0, 0, 0, 0, 0, 0];
                    updateUserUI();
                    initEarningsChart();
                }
            } else {
                // Use current weekly earnings
                weeklyEarnings = currentUser.weeklyEarnings || [0, 0, 0, 0, 0, 0, 0];
                updateUserUI();
                initEarningsChart();
            }
        }

        // Update weekly earnings for current day
        function updateWeeklyEarnings(amount) {
            if (!currentUser) return;
            
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
            
            // Adjust for our week starting on Monday (index 0)
            let adjustedDay = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
            
            // Update the earnings for today
            weeklyEarnings[adjustedDay] += amount;
            
            // Update user data in Firestore
            const userRef = db.collection('users').doc(currentUser.id.toString());
            userRef.update({
                weeklyEarnings: weeklyEarnings,
                lastEarningUpdate: today.toISOString().split('T')[0]
            }).then(() => {
                currentUser.weeklyEarnings = weeklyEarnings;
                updateUserUI();
                initEarningsChart();
            });
        }

        // Load app configuration from Firestore
        function loadAppConfig() {
            db.collection('appConfig').doc('settings').get().then((doc) => {
                if (doc.exists) {
                    appConfig = doc.data();
                    updateConfigUI();
                } else {
                    // Create default config
                    const defaultConfig = {
                        dailyAdReward: 0.001,
                        dailyAdLimit: 20,
                        referralBonus: 0.010,
                        minWithdrawalAmount: 2,
                        minWithdrawalReferrals: 10,
                        withdrawalMethods: [
                            { name: "USDT (BEP-20)", min: 2 },
                            { name: "USDT (TRC-20)", min: 2 }
                        ]
                    };
                    
                    db.collection('appConfig').doc('settings').set(defaultConfig).then(() => {
                        appConfig = defaultConfig;
                        updateConfigUI();
                    });
                }
            }).catch((error) => {
                console.error('Error loading app config:', error);
            });
        }

        // Update UI with app configuration
        function updateConfigUI() {
            // User panel updates
            document.getElementById('ad-reward').textContent = `+${appConfig.dailyAdReward || 0.001} USDT`;
            document.getElementById('referral-bonus').textContent = appConfig.referralBonus || 0.010;
            
            // Admin panel updates
            if (isAdmin) {
                document.getElementById('daily-ad-reward').value = appConfig.dailyAdReward || 0.001;
                document.getElementById('daily-ad-limit').value = appConfig.dailyAdLimit || 20;
                document.getElementById('referral-bonus-config').value = appConfig.referralBonus || 0.010;
                document.getElementById('min-withdrawal-amount-config').value = appConfig.minWithdrawalAmount || 2;
                document.getElementById('min-withdrawal-refs-config').value = appConfig.minWithdrawalReferrals || 10;
                document.getElementById('withdrawal-methods').value = JSON.stringify(appConfig.withdrawalMethods || [], null, 2);
            }
        }

        // Load bonus tasks from Firestore
        function loadBonusTasks() {
            const container = document.getElementById('bonus-tasks-container');
            container.innerHTML = '';
            
            db.collection('tasks').get().then((querySnapshot) => {
                if (querySnapshot.empty) {
                    container.innerHTML = '<div class="task-card">No tasks available at the moment.</div>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const task = { id: doc.id, ...doc.data() };
                    const isCompleted = currentUser.completedBonusTasks && currentUser.completedBonusTasks.includes(task.id);
                    
                    const taskElement = document.createElement('div');
                    taskElement.className = 'task-card';
                    taskElement.innerHTML = `
                        <div class="task-header">
                            <div class="task-title">${task.title}</div>
                            <div class="task-reward">+${task.reward} USDT</div>
                        </div>
                        <div class="task-description">${task.description}</div>
                        <button class="btn ${isCompleted ? 'btn-secondary' : 'btn-primary'}" 
                                data-task-id="${task.id}" 
                                ${isCompleted ? 'disabled' : ''}>
                            ${isCompleted ? 'Claimed' : 'Claim Bonus'}
                        </button>
                    `;
                    
                    container.appendChild(taskElement);
                    
                    // Add event listener for claim button
                    if (!isCompleted) {
                        const claimBtn = taskElement.querySelector('button');
                        claimBtn.addEventListener('click', () => claimBonusTask(task.id, task.reward));
                    }
                });
            }).catch((error) => {
                console.error('Error loading tasks:', error);
                container.innerHTML = '<div class="task-card">Error loading tasks. Please try again.</div>';
            });
        }

        // Claim a bonus task
        function claimBonusTask(taskId, reward) {
            if (!currentUser) return;
            
            // Mark task as completed
            const userRef = db.collection('users').doc(currentUser.id.toString());
            userRef.update({
                completedBonusTasks: firebase.firestore.FieldValue.arrayUnion(taskId),
                mainBalance: firebase.firestore.FieldValue.increment(parseFloat(reward))
            }).then(() => {
                // Update local user data
                currentUser.completedBonusTasks.push(taskId);
                currentUser.mainBalance += parseFloat(reward);
                
                // Update weekly earnings
                updateWeeklyEarnings(parseFloat(reward));
                
                // Update UI
                updateUserUI();
                
                // Show success message
                alert(`Success! You've earned ${reward} USDT.`);
            }).catch((error) => {
                console.error('Error claiming bonus task:', error);
                alert('Error claiming bonus. Please try again.');
            });
        }

        // Load leaderboard data
        function loadLeaderboard(type) {
            const containerId = type === 'referrers' ? 'referrers-leaderboard' : 'earners-leaderboard';
            const container = document.getElementById(containerId);
            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
            
            const field = type === 'referrers' ? 'referrals' : 'mainBalance';
            
            db.collection('users')
                .orderBy(field, 'desc')
                .limit(50)
                .get()
                .then((querySnapshot) => {
                    container.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px;">No data available.</div>';
                        return;
                    }
                    
                    let rank = 1;
                    querySnapshot.forEach((doc) => {
                        const user = doc.data();
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        
                        // Determine rank color
                        let rankClass = '';
                        if (rank === 1) rankClass = 'leaderboard-rank-gold';
                        else if (rank === 2) rankClass = 'leaderboard-rank-silver';
                        else if (rank === 3) rankClass = 'leaderboard-rank-bronze';
                        
                        const displayValue = type === 'referrers' ? user.referrals : user.mainBalance.toFixed(3);
                        const valueLabel = type === 'referrers' ? 'referrals' : 'USDT';
                        
                        item.innerHTML = `
                            <div class="leaderboard-rank ${rankClass}">#${rank}</div>
                            <div class="leaderboard-avatar">${user.firstName ? user.firstName[0] : 'U'}</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${user.firstName || 'User'}</div>
                                <div class="leaderboard-username">@${user.username || 'unknown'}</div>
                            </div>
                            <div class="leaderboard-value">${displayValue} ${valueLabel}</div>
                        `;
                        
                        container.appendChild(item);
                        rank++;
                    });
                })
                .catch((error) => {
                    console.error('Error loading leaderboard:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px;">Error loading leaderboard.</div>';
                });
        }

        // Load withdrawal history for current user
        function loadWithdrawalHistory() {
            if (!currentUser) return;
            
            const container = document.getElementById('withdrawal-history');
            container.innerHTML = '<div style="text-align: center; padding: 20px;">Loading...</div>';
            
            db.collection('withdrawals')
                .where('userId', '==', currentUser.id)
                .orderBy('requestDate', 'desc')
                .get()
                .then((querySnapshot) => {
                    container.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        container.innerHTML = '<div style="text-align: center; padding: 20px;">No withdrawal history.</div>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const withdrawal = { id: doc.id, ...doc.data() };
                        const item = document.createElement('div');
                        item.className = 'withdrawal-item';
                        
                        const date = withdrawal.requestDate ? withdrawal.requestDate.toDate().toLocaleDateString() : 'Unknown';
                        const statusClass = `status-${withdrawal.status || 'pending'}`;
                        
                        item.innerHTML = `
                            <div>
                                <div>${date}</div>
                                <div style="font-size: 12px; color: var(--on-surface-secondary);">${withdrawal.method || ''}</div>
                            </div>
                            <div style="font-weight: bold;">${withdrawal.amount} USDT</div>
                            <div class="withdrawal-status ${statusClass}">${withdrawal.status || 'Pending'}</div>
                        `;
                        
                        container.appendChild(item);
                    });
                })
                .catch((error) => {
                    console.error('Error loading withdrawal history:', error);
                    container.innerHTML = '<div style="text-align: center; padding: 20px;">Error loading history.</div>';
                });
        }

        // Show admin login screen
        function showAdminLogin() {
            adminLoginContainer.style.display = 'block';
            adminDashboard.style.display = 'none';
        }

        // Show admin dashboard
        function showAdminDashboard() {
            adminLoginContainer.style.display = 'none';
            adminDashboard.style.display = 'block';
            isAdmin = true;
            
            // Load admin data
            loadAdminStats();
            loadUsersTable();
            loadTasksTable();
            loadWithdrawalsTable();
            updateConfigUI();
        }

        // Load admin statistics
        function loadAdminStats() {
            // Total users
            db.collection('users').get().then((querySnapshot) => {
                document.getElementById('total-users').textContent = querySnapshot.size;
            });
            
            // Total USDT earned (sum of all mainBalances)
            db.collection('users').get().then((querySnapshot) => {
                let total = 0;
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    total += user.mainBalance || 0;
                });
                document.getElementById('total-usdt-earned').textContent = total.toFixed(3) + ' USDT';
            });
            
            // Pending withdrawals
            db.collection('withdrawals')
                .where('status', '==', 'pending')
                .get()
                .then((querySnapshot) => {
                    document.getElementById('pending-withdrawals').textContent = querySnapshot.size;
                });
            
            // Approved withdrawals
            db.collection('withdrawals')
                .where('status', '==', 'approved')
                .get()
                .then((querySnapshot) => {
                    document.getElementById('approved-withdrawals').textContent = querySnapshot.size;
                });
        }

        // Load users table for admin
        function loadUsersTable() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Loading...</td></tr>';
            
            db.collection('users').get().then((querySnapshot) => {
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No users found.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const user = { id: doc.id, ...doc.data() };
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${user.userId}</td>
                        <td>${user.username || 'N/A'}</td>
                        <td>${user.mainBalance ? user.mainBalance.toFixed(3) : 0}</td>
                        <td>${user.referrals || 0}</td>
                        <td>
                            <button class="btn btn-primary btn-sm edit-user-btn" data-user-id="${user.id}">Edit</button>
                            <button class="btn ${user.isBanned ? 'btn-success' : 'btn-error'} btn-sm ban-user-btn" data-user-id="${user.id}">
                                ${user.isBanned ? 'Unban' : 'Ban'}
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Add event listeners for edit and ban buttons
                document.querySelectorAll('.edit-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        openUserEditModal(userId);
                    });
                });
                
                document.querySelectorAll('.ban-user-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const userId = e.target.getAttribute('data-user-id');
                        toggleUserBan(userId);
                    });
                });
            });
        }

        // Load tasks table for admin
        function loadTasksTable() {
            const tbody = document.getElementById('tasks-table-body');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Loading...</td></tr>';
            
            db.collection('tasks').get().then((querySnapshot) => {
                tbody.innerHTML = '';
                
                if (querySnapshot.empty) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No tasks found.</td></tr>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const task = { id: doc.id, ...doc.data() };
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td>${task.title}</td>
                        <td>${task.description}</td>
                        <td>${task.reward} USDT</td>
                        <td>
                            <button class="btn btn-warning btn-sm edit-task-btn" data-task-id="${task.id}">Edit</button>
                            <button class="btn btn-error btn-sm delete-task-btn" data-task-id="${task.id}">Delete</button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Add event listeners for edit and delete buttons
                document.querySelectorAll('.edit-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = e.target.getAttribute('data-task-id');
                        // Implement task editing
                        alert('Edit task functionality would go here');
                    });
                });
                
                document.querySelectorAll('.delete-task-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const taskId = e.target.getAttribute('data-task-id');
                        if (confirm('Are you sure you want to delete this task?')) {
                            db.collection('tasks').doc(taskId).delete().then(() => {
                                loadTasksTable();
                            });
                        }
                    });
                });
            });
        }

        // Load withdrawals table for admin
        function loadWithdrawalsTable() {
            const tbody = document.getElementById('withdrawals-table-body');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';
            
            db.collection('withdrawals')
                .orderBy('requestDate', 'desc')
                .get()
                .then((querySnapshot) => {
                    tbody.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No withdrawals found.</td></tr>';
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const withdrawal = { id: doc.id, ...doc.data() };
                        const row = document.createElement('tr');
                        
                        const date = withdrawal.requestDate ? withdrawal.requestDate.toDate().toLocaleDateString() : 'Unknown';
                        const statusClass = `status-${withdrawal.status || 'pending'}`;
                        
                        row.innerHTML = `
                            <td>${date}</td>
                            <td>${withdrawal.username || 'Unknown'}</td>
                            <td>${withdrawal.amount} USDT</td>
                            <td>${withdrawal.walletAddress || 'N/A'}</td>
                            <td>${withdrawal.method || 'N/A'}</td>
                            <td><span class="withdrawal-status ${statusClass}">${withdrawal.status || 'Pending'}</span></td>
                            <td>
                                ${withdrawal.status === 'pending' ? `
                                    <button class="btn btn-success btn-sm approve-withdrawal-btn" data-withdrawal-id="${withdrawal.id}">Approve</button>
                                    <button class="btn btn-error btn-sm reject-withdrawal-btn" data-withdrawal-id="${withdrawal.id}">Reject</button>
                                ` : 'No actions'}
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    // Add event listeners for approve and reject buttons
                    document.querySelectorAll('.approve-withdrawal-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const withdrawalId = e.target.getAttribute('data-withdrawal-id');
                            updateWithdrawalStatus(withdrawalId, 'approved');
                        });
                    });
                    
                    document.querySelectorAll('.reject-withdrawal-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const withdrawalId = e.target.getAttribute('data-withdrawal-id');
                            updateWithdrawalStatus(withdrawalId, 'rejected');
                        });
                    });
                });
        }

        // Update withdrawal status
        function updateWithdrawalStatus(withdrawalId, status) {
            db.collection('withdrawals').doc(withdrawalId).update({
                status: status,
                processedDate: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                loadWithdrawalsTable();
                loadAdminStats();
                
                if (status === 'rejected') {
                    // Return funds to user's main balance
                    db.collection('withdrawals').doc(withdrawalId).get().then((doc) => {
                        const withdrawal = doc.data();
                        db.collection('users').doc(withdrawal.userId).update({
                            mainBalance: firebase.firestore.FieldValue.increment(withdrawal.amount)
                        });
                    });
                }
            });
        }

        // Open user edit modal
        function openUserEditModal(userId) {
            db.collection('users').doc(userId).get().then((doc) => {
                if (doc.exists) {
                    const user = doc.data();
                    
                    document.getElementById('edit-user-id').value = user.userId;
                    document.getElementById('edit-username').value = user.username || '';
                    document.getElementById('edit-main-balance').value = user.mainBalance || 0;
                    document.getElementById('edit-referrals').value = user.referrals || 0;
                    
                    // Store the user ID for saving
                    document.getElementById('save-user-btn').setAttribute('data-user-id', userId);
                    document.getElementById('ban-user-btn').setAttribute('data-user-id', userId);
                    
                    // Show modal
                    document.getElementById('user-edit-modal').style.display = 'flex';
                }
            });
        }

        // Toggle user ban status
        function toggleUserBan(userId) {
            db.collection('users').doc(userId).get().then((doc) => {
                if (doc.exists) {
                    const user = doc.data();
                    const newBanStatus = !user.isBanned;
                    
                    db.collection('users').doc(userId).update({
                        isBanned: newBanStatus
                    }).then(() => {
                        loadUsersTable();
                        alert(`User ${newBanStatus ? 'banned' : 'unbanned'} successfully.`);
                    });
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // User panel navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const screenId = item.getAttribute('data-screen');
                    
                    // Update active nav item
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show selected screen
                    document.querySelectorAll('.screen').forEach(screen => screen.classList.remove('active'));
                    document.getElementById(screenId).classList.add('active');
                });
            });
            
            // Leaderboard tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabType = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show selected leaderboard
                    document.getElementById('referrers-leaderboard').style.display = tabType === 'referrers' ? 'block' : 'none';
                    document.getElementById('earners-leaderboard').style.display = tabType === 'earners' ? 'block' : 'none';
                    
                    // Load leaderboard data if needed
                    if (tabType === 'referrers') {
                        loadLeaderboard('referrers');
                    } else {
                        loadLeaderboard('earners');
                    }
                });
            });
            
            // Watch ad button with Ad SDK integration
            document.getElementById('watch-ad-btn').addEventListener('click', () => {
                if (!currentUser) return;
                
                const todayAds = currentUser.todayAdsWatched || 0;
                const dailyLimit = 20;
                
                if (todayAds >= dailyLimit) {
                    alert('You have reached your daily ad limit. Come back tomorrow!');
                    return;
                }
                
                // Show ad modal
                document.getElementById('ad-modal').style.display = 'flex';
                document.getElementById('ad-status').textContent = 'Loading advertisement...';
                
                // Execute Ad SDK function
                try {
                    // Show the ad using the provided SDK
                    show_10001127({ 
                        type: 'inApp', 
                        inAppSettings: { 
                            frequency: 2, 
                            capping: 0.1, 
                            interval: 30, 
                            timeout: 5, 
                            everyPage: false 
                        } 
                    });
                    
                    // For testing purposes, we'll simulate ad completion after 3 seconds
                    // In production, you would use the SDK's callback mechanism
                    setTimeout(() => {
                        // Reward user for watching ad
                        const reward = 0.001; // $0.001 USDT per ad
                        
                        const userRef = db.collection('users').doc(currentUser.id.toString());
                        userRef.update({
                            mainBalance: firebase.firestore.FieldValue.increment(reward),
                            totalAdsWatched: firebase.firestore.FieldValue.increment(1),
                            todayAdsWatched: firebase.firestore.FieldValue.increment(1),
                            lastAdWatchTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }).then(() => {
                            // Update local user data
                            currentUser.mainBalance += reward;
                            currentUser.totalAdsWatched = (currentUser.totalAdsWatched || 0) + 1;
                            currentUser.todayAdsWatched = (currentUser.todayAdsWatched || 0) + 1;
                            
                            // Update weekly earnings
                            updateWeeklyEarnings(reward);
                            
                            // Update UI
                            updateUserUI();
                            
                            // Close modal
                            document.getElementById('ad-modal').style.display = 'none';
                            
                            // Show success message
                            alert(`You've earned ${reward} USDT!`);
                        });
                    }, 3000); // Simulate 3 second ad
                    
                } catch (error) {
                    console.error('Error loading ad:', error);
                    document.getElementById('ad-status').textContent = 'Error loading ad. Please try again.';
                    
                    // Show skip button in case of error
                    document.getElementById('skip-ad-btn').style.display = 'block';
                }
            });
            
            // Skip ad button (for testing/fallback)
            document.getElementById('skip-ad-btn').addEventListener('click', () => {
                // Reward user for watching ad (fallback)
                const reward = 0.001;
                
                const userRef = db.collection('users').doc(currentUser.id.toString());
                userRef.update({
                    mainBalance: firebase.firestore.FieldValue.increment(reward),
                    totalAdsWatched: firebase.firestore.FieldValue.increment(1),
                    todayAdsWatched: firebase.firestore.FieldValue.increment(1),
                    lastAdWatchTimestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).then(() => {
                    // Update local user data
                    currentUser.mainBalance += reward;
                    currentUser.totalAdsWatched = (currentUser.totalAdsWatched || 0) + 1;
                    currentUser.todayAdsWatched = (currentUser.todayAdsWatched || 0) + 1;
                    
                    // Update weekly earnings
                    updateWeeklyEarnings(reward);
                    
                    // Update UI
                    updateUserUI();
                    
                    // Close modal
                    document.getElementById('ad-modal').style.display = 'none';
                    
                    // Show success message
                    alert(`You've earned ${reward} USDT!`);
                });
            });
            
            // Close ad modal
            document.getElementById('close-ad-modal').addEventListener('click', () => {
                document.getElementById('ad-modal').style.display = 'none';
            });
            
            // Copy referral link
            document.getElementById('copy-link-btn').addEventListener('click', () => {
                const linkInput = document.getElementById('referral-link');
                linkInput.select();
                document.execCommand('copy');
                
                // Show feedback
                const originalText = document.getElementById('copy-link-btn').textContent;
                document.getElementById('copy-link-btn').textContent = 'Copied!';
                setTimeout(() => {
                    document.getElementById('copy-link-btn').textContent = originalText;
                }, 2000);
            });
            
            // Withdraw button
            document.getElementById('withdraw-btn').addEventListener('click', () => {
                if (!currentUser) return;
                
                const minRefs = 10;
                if (currentUser.referrals < minRefs) {
                    alert(`You need at least ${minRefs} referrals to withdraw funds.`);
                    return;
                }
                
                const minAmount = 2;
                if (currentUser.mainBalance < minAmount) {
                    alert(`You need at least ${minAmount} USDT to withdraw.`);
                    return;
                }
                
                // Populate withdrawal methods
                const methodSelect = document.getElementById('withdrawal-method');
                methodSelect.innerHTML = '<option value="">Select method</option>';
                
                if (appConfig.withdrawalMethods && Array.isArray(appConfig.withdrawalMethods)) {
                    appConfig.withdrawalMethods.forEach(method => {
                        const option = document.createElement('option');
                        option.value = method.name;
                        option.textContent = `${method.name} (Min: ${method.min} USDT)`;
                        methodSelect.appendChild(option);
                    });
                }
                
                // Set available balance
                document.getElementById('available-balance').textContent = currentUser.mainBalance.toFixed(3);
                
                // Show withdrawal modal
                document.getElementById('withdrawal-modal').style.display = 'flex';
            });
            
            // Close withdrawal modal
            document.getElementById('close-withdrawal-modal').addEventListener('click', () => {
                document.getElementById('withdrawal-modal').style.display = 'none';
            });
            
            // Submit withdrawal request
            document.getElementById('submit-withdrawal-btn').addEventListener('click', () => {
                const method = document.getElementById('withdrawal-method').value;
                const address = document.getElementById('withdrawal-address').value;
                const amount = parseFloat(document.getElementById('withdrawal-amount').value);
                
                if (!method) {
                    alert('Please select a withdrawal method.');
                    return;
                }
                
                if (!address) {
                    alert('Please enter your wallet address or payment ID.');
                    return;
                }
                
                if (!amount || amount < 2) {
                    alert('Minimum withdrawal amount is 2 USDT.');
                    return;
                }
                
                if (amount > currentUser.mainBalance) {
                    alert('Insufficient balance.');
                    return;
                }
                
                // Create withdrawal request
                const withdrawalData = {
                    userId: currentUser.id,
                    username: currentUser.username,
                    firstName: currentUser.firstName,
                    amount: amount,
                    method: method,
                    walletAddress: address,
                    status: 'pending',
                    requestDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                db.collection('withdrawals').add(withdrawalData).then(() => {
                    // Deduct amount from user's main balance
                    const userRef = db.collection('users').doc(currentUser.id.toString());
                    return userRef.update({
                        mainBalance: firebase.firestore.FieldValue.increment(-amount)
                    });
                }).then(() => {
                    // Update local user data
                    currentUser.mainBalance -= amount;
                    
                    // Update UI
                    updateUserUI();
                    
                    // Close modal
                    document.getElementById('withdrawal-modal').style.display = 'none';
                    
                    alert('Withdrawal request submitted successfully!');
                }).catch((error) => {
                    console.error('Error submitting withdrawal request:', error);
                    alert('Error submitting withdrawal request. Please try again.');
                });
            });
            
            // Theme toggle
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('admin-theme-toggle').addEventListener('click', toggleTheme);
            
            // Admin login
            document.getElementById('admin-login-btn').addEventListener('click', () => {
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                
                // Simple hardcoded login for demo (in production, use Firebase Auth)
                if (email === 'admin@superairdrop.com' && password === 'admin123') {
                    localStorage.setItem('adminUser', JSON.stringify({ email: email }));
                    showAdminDashboard();
                } else {
                    alert('Invalid credentials');
                }
            });
            
            // Admin logout
            document.getElementById('admin-logout-btn').addEventListener('click', () => {
                localStorage.removeItem('adminUser');
                showAdminLogin();
            });
            
            // Admin navigation
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const sectionId = item.getAttribute('data-section') + '-section';
                    
                    // Update active nav item
                    document.querySelectorAll('.admin-nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Show selected section
                    document.querySelectorAll('.admin-section').forEach(section => section.classList.remove('active'));
                    document.getElementById(sectionId).classList.add('active');
                });
            });
            
            // Add task button
            document.getElementById('add-task-btn').addEventListener('click', () => {
                const title = document.getElementById('task-title').value;
                const description = document.getElementById('task-description').value;
                const reward = parseFloat(document.getElementById('task-reward').value);
                const url = document.getElementById('task-url').value;
                
                if (!title || !description || !reward) {
                    alert('Please fill in all required fields.');
                    return;
                }
                
                const taskData = {
                    title: title,
                    description: description,
                    reward: reward,
                    url: url,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                db.collection('tasks').add(taskData).then(() => {
                    // Clear form
                    document.getElementById('task-title').value = '';
                    document.getElementById('task-description').value = '';
                    document.getElementById('task-reward').value = '';
                    document.getElementById('task-url').value = '';
                    
                    // Reload tasks table
                    loadTasksTable();
                    
                    alert('Task added successfully!');
                }).catch((error) => {
                    console.error('Error adding task:', error);
                    alert('Error adding task. Please try again.');
                });
            });
            
            // Save configuration
            document.getElementById('save-config-btn').addEventListener('click', () => {
                const dailyAdReward = parseFloat(document.getElementById('daily-ad-reward').value);
                const dailyAdLimit = parseInt(document.getElementById('daily-ad-limit').value);
                const referralBonus = parseFloat(document.getElementById('referral-bonus-config').value);
                const minWithdrawalAmount = parseFloat(document.getElementById('min-withdrawal-amount-config').value);
                const minWithdrawalRefs = parseInt(document.getElementById('min-withdrawal-refs-config').value);
                
                let withdrawalMethods = [];
                try {
                    withdrawalMethods = JSON.parse(document.getElementById('withdrawal-methods').value);
                } catch (e) {
                    alert('Invalid JSON format for withdrawal methods.');
                    return;
                }
                
                const configData = {
                    dailyAdReward: dailyAdReward,
                    dailyAdLimit: dailyAdLimit,
                    referralBonus: referralBonus,
                    minWithdrawalAmount: minWithdrawalAmount,
                    minWithdrawalReferrals: minWithdrawalRefs,
                    withdrawalMethods: withdrawalMethods
                };
                
                db.collection('appConfig').doc('settings').update(configData).then(() => {
                    appConfig = { ...appConfig, ...configData };
                    updateConfigUI();
                    alert('Configuration saved successfully!');
                }).catch((error) => {
                    console.error('Error saving configuration:', error);
                    alert('Error saving configuration. Please try again.');
                });
            });
            
            // Save user edits
            document.getElementById('save-user-btn').addEventListener('click', () => {
                const userId = document.getElementById('save-user-btn').getAttribute('data-user-id');
                const mainBalance = parseFloat(document.getElementById('edit-main-balance').value);
                const referrals = parseInt(document.getElementById('edit-referrals').value);
                
                db.collection('users').doc(userId).update({
                    mainBalance: mainBalance,
                    referrals: referrals
                }).then(() => {
                    // Close modal
                    document.getElementById('user-edit-modal').style.display = 'none';
                    
                    // Reload users table
                    loadUsersTable();
                    
                    alert('User updated successfully!');
                }).catch((error) => {
                    console.error('Error updating user:', error);
                    alert('Error updating user. Please try again.');
                });
            });
            
            // Ban user button
            document.getElementById('ban-user-btn').addEventListener('click', () => {
                const userId = document.getElementById('ban-user-btn').getAttribute('data-user-id');
                toggleUserBan(userId);
                document.getElementById('user-edit-modal').style.display = 'none';
            });
            
            // Close user edit modal
            document.getElementById('close-user-edit-modal').addEventListener('click', () => {
                document.getElementById('user-edit-modal').style.display = 'none';
            });
        }

        // Toggle theme (light/dark mode)
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle icon
            const themeIcons = document.querySelectorAll('.theme-toggle i');
            themeIcons.forEach(icon => {
                icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            });
        }

        // Initialize theme from localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // Set initial theme toggle icon
        const themeIcons = document.querySelectorAll('.theme-toggle i');
        themeIcons.forEach(icon => {
            icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        });

        // Simple chart implementation for weekly earnings
        function initEarningsChart() {
            const ctx = document.getElementById('earnings-chart').getContext('2d');
            
            // Create a simple bar chart
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            // Draw chart
            const maxEarning = Math.max(...weeklyEarnings, 0.001); // Avoid division by zero
            const barWidth = 30;
            const spacing = 10;
            const chartHeight = 150;
            
            // Clear canvas
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
            
            // Draw bars
            for (let i = 0; i < days.length; i++) {
                const x = i * (barWidth + spacing) + 20;
                const barHeight = (weeklyEarnings[i] / maxEarning) * (chartHeight - 30);
                const y = chartHeight - barHeight - 20;
                
                // Draw bar
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--primary');
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw label
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--on-surface');
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(days[i], x + barWidth / 2, chartHeight - 5);
                
                // Draw value
                ctx.fillText(weeklyEarnings[i].toFixed(3), x + barWidth / 2, y - 5);
            }
        }

        // Initialize chart when page loads
        window.addEventListener('load', initEarningsChart);
    </script>
</body>
</html>
